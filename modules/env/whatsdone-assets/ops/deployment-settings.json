{
  "moduleName": "whatsdone-assets",
  "config": {
    "script": "node -p \"JSON.stringify(require('../module-config/$KUMO_ENV.js'))\""
  },
  "tasks": [
    {
      "id": "create-assets-bucket",
      "type": "cf-stack",
      "stackName": "module",
      "stackTemplate": {
        "script": "sed \"s/__DELETION_POLICY__/$DELETION_POLICY/\" ./template.json > $KUMO_TEMPLATE_OUTPUT_FILE",
        "envVars": {
          "DELETION_POLICY": {"$ref": "#/_deploymentConfig/bucketDeletionPolicy"}
        }
      },
      "stackParams": {
        "BucketName": {"$ref": "#/_deploymentConfig/bucketName"}
      }
    },
    {
      "id": "empty-bucket",
      "type": "custom",
      "undo": {
        "script": "[[ \"$DELETION_POLICY\" == Delete ]] && aws s3 rm s3://$BUCKET_NAME --recursive",
        "envVars": {
          "BUCKET_NAME": {"$ref": "#/_deploymentConfig/bucketName"},
          "DELETION_POLICY": {"$ref": "#/_deploymentConfig/bucketDeletionPolicy"}
        }
      }
    },
    {
      "id": "deploy-assets",
      "type": "custom",
      "run": {
        "script": "./deploy-assets.sh $KUMO_DEPLOYMENT_CONFIG"
      }
    }
  ]
}
