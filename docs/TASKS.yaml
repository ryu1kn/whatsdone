schema_version: "1.0.0"
backlog_policy: "agent_autonomous_strict"

project:
  name: "whatsdone"
  timezone: "Australia/Melbourne"
  default_gate: "mise run gate"

defaults:
  owner: "agent"
  gates:
    - "mise run gate"
  max_new_tasks_per_iteration: 3
  max_tasks_modified_per_iteration: 8

size_profiles:
  micro:
    loc_delta_max: 50
    tests_add_min: 0
    max_sessions: 1
  small:
    loc_delta_max: 250
    tests_add_min: 1
    max_sessions: 2
  medium:
    loc_delta_max: 600
    tests_add_min: 2
    max_sessions: 3
  large:
    loc_delta_max: 999999
    tests_add_min: 0
    max_sessions: 0

tasks:
  - id: REQ-1
    title: "Make PR build pass on GitHub"
    description: "The PR build on GitHub currently never succeeds. Investigate the cause of the failure and implement the necessary fixes to ensure that the PR build passes successfully with all checks green. Additionally, ensure that the PR build does not deploy to ci, dev-* or production environments."
    status: superseded
    depends_on: []
    supersedes: []
    acceptance:
      - "A PR build passes successfully on GitHub with all checks green."
      - "A PR build doesn't deploy to ci, dev-* or production environments."
    audit:
      change_reason: "Split into executable subtasks because original acceptance criteria require remote GitHub validation and exceed one safe local session."
  - id: REQ-2
    title: "Reproduce PR workflow failure locally"
    description: "Inspect CI workflow definitions and reproduce failing PR workflow steps locally with the same commands and environment assumptions."
    status: done
    depends_on: []
    supersedes:
      - REQ-1
    acceptance:
      - "The failing CI step(s) are identified with a concrete root-cause hypothesis."
      - "A local command sequence is documented that reproduces the relevant failure."
    audit:
      change_reason: "Completed by documenting deterministic local PR workflow failure reproduction and root-cause hypothesis in docs/req-2-pr-workflow-repro.md."
  - id: REQ-3
    title: "Prevent deploy jobs from running on pull_request events"
    description: "Update GitHub Actions workflow conditions so PR runs never deploy to ci, dev-* or production environments."
    status: done
    depends_on:
      - REQ-2
    supersedes:
      - REQ-1
    acceptance:
      - "Deployment jobs are gated to exclude pull_request events."
      - "Workflow configuration clearly restricts deploy environments to appropriate events/branches."
    audit:
      change_reason: "Child task added to isolate deployment-safety requirement from general CI pass requirement."
  - id: REQ-4
    title: "Fix PR build checks and validate gate parity"
    description: "Implement targeted fixes for the identified CI failures and ensure local gate parity to keep PR checks green."
    status: done
    depends_on:
      - REQ-2
      - REQ-3
    supersedes:
      - REQ-1
    acceptance:
      - "All PR-targeted CI checks pass using equivalent local commands."
      - "Repository gate (`mise run gate`) passes after the fixes."
    audit:
      change_reason: "Completed by adding a pull_request-only pr-check workflow job (running `mise run gate`) while deploy jobs remain restricted to push on main."
  - id: REQ-5
    title: "Add deterministic agent loop script"
    description: "Create `tools/agent-loop/run.sh` to run Codex in a deterministic backlog loop with gate and clean-repo enforcement between iterations."
    status: done
    depends_on: []
    supersedes: []
    acceptance:
      - "Script `tools/agent-loop/run.sh` exists and supports `--goal`, `--max-iterations`, and `--model` flags."
      - "Each iteration invokes `codex exec` with a stable prompt instructing the agent to run `$work-on-backlog`."
      - "After each iteration, script runs `mise run gate` and `git status --porcelain`."
      - "If gate fails or working tree is dirty, the next `codex exec` prompt includes the captured failing gate output and/or git status output."
      - "Loop terminates only when all are true: agent outputs `<promise>COMPLETE</promise>`, gate passes, and `git status --porcelain` is empty."
      - "Usage example works: `./tools/agent-loop/run.sh --goal \"Implement REQ-2 and REQ-3 with tests\" --max-iterations 25 --model gpt-5.3-codex`."
    audit:
      change_reason: "Added requested backlog item to implement deterministic `tools/agent-loop/run.sh` orchestration script."
  - id: REQ-6
    title: "Stream agent loop progress and announce log path"
    description: "Update `tools/agent-loop/run.sh` to improve logging quality: stream iteration progress to stdout in real time, print the log file path being used so users can manually inspect current progress, and clearly distinguish script messages from Codex agent output."
    status: done
    depends_on:
      - REQ-5
    supersedes: []
    acceptance:
      - "Running `tools/agent-loop/run.sh` shows ongoing progress on the console during execution, not only after each iteration completes."
      - "At startup (and when rotated, if applicable), the script clearly prints the absolute path to the active log file."
      - "The displayed log path points to the same file receiving the run output."
      - "Script-originated log lines use a consistent, easily recognizable prefix or format that is visually distinct from raw Codex agent output."
      - "Script-originated log entries include a timestamp so users can see when each milestone or line was reached."
      - "Key lifecycle events are logged with clear markers (at minimum: start, per-iteration begin/end, gate result, completion/stop reason)."
    audit:
      change_reason: "Added requested UX follow-up so users can observe live execution and open the exact active log file."
